#!/bin/bash

# Set your API key, username, and password for the Nexpose InsightVM API
API_KEY="YOUR_API_KEY"
USERNAME="YOUR_USERNAME"
PASSWORD="YOUR_PASSWORD"
API_URL="https://insightvm.example.com/api/3"

# Specify the output file
OUTPUT_FILE="scan_dates.txt"

# Get an authentication token using the username and password
token=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username":"'${USERNAME}'","password":"'${PASSWORD}'"}' "${API_URL}/authenticate" | sed -n 's/.*"token":"\([^"]*\)".*/\1/p')

# Get a list of all sites
sites=$(curl -s -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" "${API_URL}/sites" | sed -n 's/.*"id":\([0-9]*\),.*/\1/p')

# Loop through each site and write its last scan date to the output file
for site in $sites; do
  scan=$(curl -s -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" "${API_URL}/sites/${site}/scans/latest" | grep -Po '(?<="last-modified-at":")[^"]*')
  name=$(curl -s -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" "${API_URL}/sites/${site}" | grep -Po '(?<="name":")[^"]*')
  echo "${name}=${scan}" | tee -a "${OUTPUT_FILE}"
done
