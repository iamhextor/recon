import requests
import json
import urllib3
from getpass import getpass
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

username = input("Username (E-id): ")
password = getpass("Password: ")

# API call to retrieve all the sites
sites_url = "https://nespose_ip:port/api/3/sites"
sites_response = requests.get(sites_url, auth=(username, password), verify=False)
if sites_response.status_code != 200:
    print(f"Error retrieving sites: {sites_response.status_code}")
    exit()

# Extracting site details from the API response
sites_json = sites_response.json()
site_details = []

for site in sites_json['resources']:
    site_id = site['id']
    site_name = site['name']
    
    # API call to retrieve scan engine used on the site
    scan_engine_url = f"https://nespose_ip:port/api/3/sites/{site_id}/scan_engine"
    scan_engine_response = requests.get(scan_engine_url, auth=(username, password), verify=False)
    if scan_engine_response.status_code != 200:
        scan_engine_name = "N/A"
    else:
        scan_engine_json = scan_engine_response.json()
        scan_engine_name = scan_engine_json['name']
    
    # API call to retrieve last scan time on the site
    last_scan_url = f"https://nespose_ip:port/api/3/sites/{site_id}/scans?sort=start-time,desc&size=1"
    last_scan_response = requests.get(last_scan_url, auth=(username, password), verify=False)
    if last_scan_response.status_code != 200:
        last_scan_time = "N/A"
    else:
        last_scan_json = last_scan_response.json()
        last_scan_time = last_scan_json['resources'][0]['startTime']
    
    site_details.append(f"{site_name}={scan_engine_name}={last_scan_time}")

# Printing site details
for site_detail in site_details:
    print(site_detail)
