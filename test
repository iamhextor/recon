#!/bin/bash

# Set your API key, username, and password for the Nexpose InsightVM API
API_KEY="YOUR_API_KEY"
USERNAME="YOUR_USERNAME"
PASSWORD="YOUR_PASSWORD"
API_URL="https://insightvm.example.com/api/3"

# Specify the output file
OUTPUT_FILE="scan_dates.txt"

# Get an authentication token using the username and password
token=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username":"'${USERNAME}'","password":"'${PASSWORD}'"}' "${API_URL}/authenticate" | jq -r '.token')

# Get a list of all sites
sites=$(curl -s -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" "${API_URL}/sites" | jq -r '.[] | .id')

# Loop through each site and write its last scan date to the output file
for site in $sites; do
  scan=$(curl -s -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" "${API_URL}/sites/${site}/scans/latest" | jq -r '.["last-modified-at"]')
  name=$(curl -s -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" "${API_URL}/sites/${site}" | jq -r '.name')
  echo "${name}=${scan}" | tee -a "${OUTPUT_FILE}"
done
