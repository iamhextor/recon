import requests
import urllib3
from getpass import getpass

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Get username and password from user
username = input("Username (E-id): ")
password = getpass("Password: ")

# Read IP addresses from input file
with open("ips.txt", "r") as f:
    ips = [line.strip() for line in f]

# API call to retrieve asset IDs for the specified IP addresses
asset_ids = []
for ip in ips:
    asset_url = f"https://nexpose_url:port/api/3/assets?filter=search%3A%3D{ip}"
    asset_response = requests.get(asset_url, auth=(username, password), verify=False)
    if asset_response.status_code != 200:
        print(f"Error retrieving assets for {ip}: {asset_response.status_code}")
        continue

    asset_json = asset_response.json()
    if 'resources' not in asset_json or len(asset_json['resources']) == 0:
        print(f"No assets found for {ip}")
        continue

    asset_id = asset_json['resources'][0]['id']
    asset_ids.append(asset_id)

# API call to retrieve last authenticated scan date for each asset
asset_dates = []
for asset_id in asset_ids:
    scan_url = f"https://nexpose_url:port/api/3/assets/{asset_id}/authenticated_scan"
    scan_response = requests.get(scan_url, auth=(username, password), verify=False)
    if scan_response.status_code != 200:
        print(f"Error retrieving scan date for asset {asset_id}: {scan_response.status_code}")
        continue

    scan_json = scan_response.json()
    last_scan_date = scan_json.get('lastScan', 'N/A')
    asset_dates.append((asset_id, last_scan_date))

# Print last authenticated scan date for each asset
for asset_id, last_scan_date in asset_dates:
    print(f"Asset ID {asset_id}: {last_scan_date}")
